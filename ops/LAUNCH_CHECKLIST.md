# 上线前检查清单（IronCore 后端）

本清单用于生产上线前的配置与验证，确保“非托管 + 企业 API + 三端生态”在强一致、安全与可审计前提下稳定运行。

## 1. 基础设施与网络
- [ ] CockroachDB 多 AZ/Region 部署，启用 TLS，PITR 与备份策略生效（恢复演练通过）
- [ ] Redis 在私网，开启 ACL/密码与持久化策略（RDB/AOF），内存水位/命中率告警
- [ ] immudb 启用认证/加密与存储加密，审计校验作业（CRON）定期执行
- [ ] Kafka 启用 SASL/TLS，Topic 权限与 DLQ 配置，监控滞后与积压
- [ ] ClickHouse/TimescaleDB 独立集群，冷热分层/分区/物化视图，慢查询告警
- [ ] S3（MinIO/云）启用 KMS 加密、版本化、生命周期，访问日志开启

## 2. 配置与密钥
- [ ] 数据库/Redis/Kafka/S3/immudb 凭证由 Vault/KMS 托管（应用仅持引用/密文）
- [ ] 环境变量最小化，敏感信息不入镜像与仓库，K8s Secret 管理
- [ ] TLS 证书自动化（ACME/Cert-Manager），证书轮换演练

## 3. 数据与模型
- [ ] SQLx 迁移脚本（migrations/*）完整可回滚，预演通过
- [ ] 唯一约束与外键策略（ON DELETE）检查，避免孤儿记录与脏数据
- [ ] PII 列加密（列级/应用加密），最小化保存
- [ ] 审计事件双写（主库 + immudb 存证），抽检验证通过

## 4. 应用与接口
- [ ] 连接池参数来自环境变量（DB_MAX_CONNS 等），按生产规模配置
- [ ] 幂等键统一（Header/Body），写路径统一校验与保护
- [ ] 统一错误码与 JSON 错误体，/api/errors 输出与前端强类型一致
- [ ] OpenAPI /openapi.yaml 与 /docs 可访问，接口与前端强类型匹配
- [ ] 健康检查 /healthz 返回 DB/Redis 状态；就绪探针与存活探针配置
- [ ] CORS/安全头（HSTS、X-Content-Type-Options、X-Frame-Options 等）

## 5. 观测与告警
- [ ] 结构化日志与 request-id/trace-id 贯通，关键信息脱敏
- [ ] 指标与告警：QPS、P99、错误率、慢查询、复制延迟、磁盘/内存水位、缓存命中率、DLQ 积压
- [ ] 审计校验失败、数据漂移、限流触发、外部依赖失败告警

## 6. 性能与容量
- [ ] 压测与容量评估报告（QPS、并发、资源利用率），预留 30% 以上裕度
- [ ] 限流阈值合理，突发保护与降级策略完备
- [ ] 读写分离（缓存、副本 READ），分析查询迁出 OLTP

## 7. 恢复与演练
- [ ] 备份与恢复演练（RPO ≤ 5min，RTO ≤ 15min）
- [ ] 事件回放与二级索引/报表重建演练
- [ ] 蓝绿/金丝雀发布策略与回滚预案


