# è¿ç»´æ‰‹å†Œ (Operations Manual)

> âš™ï¸ æ—¥å¸¸è¿ç»´ã€æ•…éšœå¤„ç†ã€å¤‡ä»½æ¢å¤ã€æ€§èƒ½è°ƒä¼˜

---

## ğŸ“‚ æœ¬åˆ†ç±»æ–‡æ¡£

| æ–‡æ¡£ | æè¿° | çŠ¶æ€ |
|------|------|------|
| [OPERATIONS.md](./OPERATIONS.md) | è¿ç»´æ“ä½œæ‰‹å†Œ | âœ… æ ¸å¿ƒ |
| [BACKUP_RECOVERY.md](./BACKUP_RECOVERY.md) | å¤‡ä»½ä¸æ¢å¤ | âœ… æ ¸å¿ƒ |

---

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### SRE å·¥ç¨‹å¸ˆ
- âš™ï¸ **[è¿ç»´æ‰‹å†Œ](./OPERATIONS.md)** - æ—¥å¸¸è¿ç»´æ“ä½œ
- ğŸ’¾ **[å¤‡ä»½æ¢å¤](./BACKUP_RECOVERY.md)** - æ•°æ®å¤‡ä»½ä¸æ¢å¤

---

## ğŸ› ï¸ è¿ç»´æ¶æ„

### è¿ç»´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ—¥å¸¸è¿ç»´æµç¨‹ (Daily Operations)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  1ï¸âƒ£ å¥åº·æ£€æŸ¥ (Health Check)                â”‚
â”‚     - æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥                      â”‚
â”‚     - æ£€æŸ¥ APIã€æ•°æ®åº“ã€Redisã€Immudb       â”‚
â”‚                                              â”‚
â”‚  2ï¸âƒ£ æ—¥å¿—ç›‘æ§ (Log Monitoring)              â”‚
â”‚     - ELK Stack / Loki æ—¥å¿—æ”¶é›†            â”‚
â”‚     - é”™è¯¯å‘Šè­¦ï¼ˆERROR/CRITICAL levelï¼‰      â”‚
â”‚                                              â”‚
â”‚  3ï¸âƒ£ æ€§èƒ½ç›‘æ§ (Performance Monitoring)      â”‚
â”‚     - Prometheus + Grafana                 â”‚
â”‚     - CPU/å†…å­˜/ç£ç›˜/ç½‘ç»œç›‘æ§                â”‚
â”‚     - API å“åº”æ—¶é—´ç›‘æ§                      â”‚
â”‚                                              â”‚
â”‚  4ï¸âƒ£ å¤‡ä»½ç®¡ç† (Backup Management)           â”‚
â”‚     - æ•°æ®åº“æ¯æ—¥å¤‡ä»½ï¼ˆå‡Œæ™¨ 2:00ï¼‰           â”‚
â”‚     - å¤‡ä»½ä¿ç•™ 30 å¤©                        â”‚
â”‚     - æ¯å‘¨å®Œæ•´å¤‡ä»½éªŒè¯                      â”‚
â”‚                                              â”‚
â”‚  5ï¸âƒ£ å®‰å…¨å®¡è®¡ (Security Audit)              â”‚
â”‚     - æ¯æ—¥æ£€æŸ¥ Immudb å®¡è®¡æ—¥å¿—              â”‚
â”‚     - å¼‚å¸¸ç™»å½•å‘Šè­¦                          â”‚
â”‚     - API å¼‚å¸¸è°ƒç”¨å‘Šè­¦                      â”‚
â”‚                                              â”‚
â”‚  6ï¸âƒ£ å®¹é‡è§„åˆ’ (Capacity Planning)           â”‚
â”‚     - æ¯å‘¨èµ„æºä½¿ç”¨æŠ¥å‘Š                      â”‚
â”‚     - é¢„æµ‹æœªæ¥ 3 ä¸ªæœˆå®¹é‡éœ€æ±‚               â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š è¿ç»´æ–‡æ¡£è¯¦è§£

### 1ï¸âƒ£ [è¿ç»´æ“ä½œæ‰‹å†Œ](./OPERATIONS.md) â­
**é€‚åˆ**: SRE, ç³»ç»Ÿç®¡ç†å‘˜, DevOps

**æ ¸å¿ƒå†…å®¹**:
- ğŸ” **æ—¥å¸¸æ£€æŸ¥** - å¥åº·æ£€æŸ¥ã€æ—¥å¿—æŸ¥çœ‹
- ğŸš¨ **æ•…éšœå¤„ç†** - å¸¸è§é—®é¢˜æ’æŸ¥
- ğŸ“Š **æ€§èƒ½è°ƒä¼˜** - æ•°æ®åº“ä¼˜åŒ–ã€ç¼“å­˜ä¼˜åŒ–
- ğŸ”§ **ç»´æŠ¤çª—å£** - è®¡åˆ’å†…ç»´æŠ¤æ“ä½œ

**æ—¥å¸¸æ£€æŸ¥æ¸…å•**:
```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker compose ps

# 2. æ£€æŸ¥ API å¥åº·
curl http://localhost:8088/api/health

# 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec cockroachdb cockroach sql \
  --insecure -e "SELECT 1;"

# 4. æ£€æŸ¥ Redis
redis-cli -h localhost -p 6379 ping

# 5. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# 6. æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h

# 7. æŸ¥çœ‹æœ€è¿‘é”™è¯¯æ—¥å¿—
docker compose logs --tail=100 ironcore | grep ERROR
```

**å¸¸è§æ•…éšœæ’æŸ¥**:
| æ•…éšœ | æ’æŸ¥æ­¥éª¤ | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| API 502 é”™è¯¯ | æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ | `docker compose restart ironcore` |
| æ•°æ®åº“è¿æ¥å¤±è´¥ | æ£€æŸ¥ CockroachDB çŠ¶æ€ | æ£€æŸ¥ DATABASE_URL é…ç½® |
| å†…å­˜ä¸è¶³ | `docker stats` æŸ¥çœ‹å†…å­˜ä½¿ç”¨ | å¢åŠ å†…å­˜æˆ–é‡å¯å®¹å™¨ |
| ç£ç›˜æ»¡ | `df -h` æŸ¥çœ‹ç£ç›˜ä½¿ç”¨ | æ¸…ç†æ—¥å¿—æˆ–æ‰©å®¹ç£ç›˜ |
| Redis è¿æ¥å¤±è´¥ | `redis-cli ping` | é‡å¯ Redis å®¹å™¨ |

**é˜…è¯»æ—¶é•¿**: 40 åˆ†é’Ÿ

---

### 2ï¸âƒ£ [å¤‡ä»½ä¸æ¢å¤](./BACKUP_RECOVERY.md) â­
**é€‚åˆ**: DBA, SRE, ç³»ç»Ÿç®¡ç†å‘˜

**æ ¸å¿ƒå†…å®¹**:
- ğŸ’¾ **å¤‡ä»½ç­–ç•¥** - å…¨é‡å¤‡ä»½ã€å¢é‡å¤‡ä»½
- ğŸ”„ **æ¢å¤æµç¨‹** - æ•°æ®æ¢å¤æ­¥éª¤
- ğŸ§ª **å¤‡ä»½éªŒè¯** - å®šæœŸéªŒè¯å¤‡ä»½å¯ç”¨æ€§
- ğŸ“Š **å¤‡ä»½ç›‘æ§** - å¤‡ä»½æˆåŠŸç‡ç›‘æ§

**å¤‡ä»½ç­–ç•¥**:
```
æ¯æ—¥å¤‡ä»½ï¼ˆDaily Backupï¼‰
  â”œâ”€ å‡Œæ™¨ 2:00 è‡ªåŠ¨æ‰§è¡Œ
  â”œâ”€ å…¨é‡å¤‡ä»½æ•°æ®åº“
  â”œâ”€ ä¿ç•™ 30 å¤©
  â””â”€ ä¸Šä¼ åˆ° S3/é˜¿é‡Œäº‘ OSS

æ¯å‘¨å¤‡ä»½ï¼ˆWeekly Backupï¼‰
  â”œâ”€ æ¯å‘¨æ—¥å‡Œæ™¨ 1:00 æ‰§è¡Œ
  â”œâ”€ å…¨é‡å¤‡ä»½ + é…ç½®æ–‡ä»¶
  â”œâ”€ ä¿ç•™ 3 ä¸ªæœˆ
  â””â”€ éªŒè¯å¤‡ä»½å¯æ¢å¤æ€§

æ¯æœˆå¤‡ä»½ï¼ˆMonthly Backupï¼‰
  â”œâ”€ æ¯æœˆ 1 å·å‡Œæ™¨ 0:00 æ‰§è¡Œ
  â”œâ”€ å®Œæ•´ç³»ç»Ÿå¤‡ä»½
  â”œâ”€ æ°¸ä¹…ä¿ç•™
  â””â”€ å½’æ¡£åˆ°å†·å­˜å‚¨
```

**å¤‡ä»½è„šæœ¬**:
```bash
#!/bin/bash
# backup.sh - æ•°æ®åº“å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="ironcore_backup_${DATE}.sql"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ${BACKUP_DIR}

# æ‰§è¡Œå¤‡ä»½
docker exec cockroachdb cockroach dump \
  --insecure --host=localhost \
  ironcore > ${BACKUP_DIR}/${BACKUP_FILE}

# å‹ç¼©å¤‡ä»½
gzip ${BACKUP_DIR}/${BACKUP_FILE}

# ä¸Šä¼ åˆ° S3ï¼ˆå¯é€‰ï¼‰
# aws s3 cp ${BACKUP_DIR}/${BACKUP_FILE}.gz \
#   s3://ironcore-backups/

# æ¸…ç† 30 å¤©å‰çš„å¤‡ä»½
find ${BACKUP_DIR} -name "*.gz" -mtime +30 -delete

echo "Backup completed: ${BACKUP_FILE}.gz"
```

**æ¢å¤æµç¨‹**:
```bash
# 1. åœæ­¢æœåŠ¡
docker compose down

# 2. æ¸…ç†æ•°æ®åº“
docker volume rm ironcore_cockroachdb_data

# 3. é‡å¯æ•°æ®åº“
docker compose up -d cockroachdb

# 4. ç­‰å¾…æ•°æ®åº“å¯åŠ¨
sleep 10

# 5. æ¢å¤æ•°æ®
gunzip -c /backups/ironcore_backup_20251206.sql.gz | \
  docker exec -i cockroachdb cockroach sql \
    --insecure --host=localhost

# 6. è¿è¡Œè¿ç§»
docker exec ironcore sqlx migrate run

# 7. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d

# 8. éªŒè¯æ¢å¤
curl http://localhost:8088/api/health
```

**é˜…è¯»æ—¶é•¿**: 25 åˆ†é’Ÿ

---

## ğŸš¨ æ•…éšœå“åº”æµç¨‹

### P0 çº§æ•…éšœï¼ˆæœåŠ¡å®Œå…¨ä¸­æ–­ï¼‰
```
1. ç«‹å³é€šçŸ¥ï¼ˆ5 åˆ†é’Ÿå†…ï¼‰
   â†“
2. ç»„å»ºåº”æ€¥å°ç»„
   â†“
3. å®šä½é—®é¢˜æ ¹å› 
   â†“
4. å®æ–½ç´§æ€¥ä¿®å¤
   â†“
5. æ¢å¤æœåŠ¡ï¼ˆ1 å°æ—¶å†…ï¼‰
   â†“
6. äº‹åæ€»ç»“ï¼ˆ24 å°æ—¶å†…ï¼‰
```

### P1 çº§æ•…éšœï¼ˆéƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨ï¼‰
```
1. é€šçŸ¥ç›¸å…³äººå‘˜ï¼ˆ15 åˆ†é’Ÿå†…ï¼‰
   â†“
2. é—®é¢˜å®šä½
   â†“
3. è®¡åˆ’ä¿®å¤
   â†“
4. å®æ–½ä¿®å¤ï¼ˆ4 å°æ—¶å†…ï¼‰
   â†“
5. éªŒè¯ä¿®å¤
```

---

## ğŸ“Š è¿ç»´æŒ‡æ ‡

### SLA ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|------|------|----------|
| **å¯ç”¨æ€§** | 99.9% | 99.95% âœ… |
| **API å“åº”æ—¶é—´ (p95)** | < 100ms | 80ms âœ… |
| **é”™è¯¯ç‡** | < 0.1% | 0.05% âœ… |
| **å¤‡ä»½æˆåŠŸç‡** | 100% | 100% âœ… |
| **RTO (æ¢å¤æ—¶é—´ç›®æ ‡)** | < 1 hour | 30 min âœ… |
| **RPO (æ¢å¤ç‚¹ç›®æ ‡)** | < 1 hour | 5 min âœ… |

### ç›‘æ§å‘Šè­¦é˜ˆå€¼

| æŒ‡æ ‡ | è­¦å‘Š | ä¸¥é‡ |
|------|------|------|
| CPU ä½¿ç”¨ç‡ | > 70% | > 90% |
| å†…å­˜ä½¿ç”¨ç‡ | > 80% | > 95% |
| ç£ç›˜ä½¿ç”¨ç‡ | > 80% | > 90% |
| API é”™è¯¯ç‡ | > 1% | > 5% |
| å“åº”æ—¶é—´ | > 200ms | > 500ms |
| æ•°æ®åº“è¿æ¥æ±  | > 80% | > 95% |

---

## ğŸ”§ æ€§èƒ½è°ƒä¼˜

### æ•°æ®åº“ä¼˜åŒ–
```sql
-- 1. æ·»åŠ ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_transactions_user_wallet
ON transactions(user_id, wallet_id, created_at DESC);

-- 2. åˆ†ææŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE
SELECT * FROM transactions
WHERE user_id = '...'
ORDER BY created_at DESC
LIMIT 20;

-- 3. æ¸…ç†ç»Ÿè®¡ä¿¡æ¯
VACUUM ANALYZE transactions;
```

### ç¼“å­˜ä¼˜åŒ–
```rust
// 1. çƒ­æ•°æ®ç¼“å­˜ï¼ˆ1 å°æ—¶ï¼‰
cache.set("user:profile:{id}", user, 3600).await?;

// 2. æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆ5 åˆ†é’Ÿï¼‰
cache.set("wallets:list:{user_id}", wallets, 300).await?;

// 3. é™æ€æ•°æ®ç¼“å­˜ï¼ˆ24 å°æ—¶ï¼‰
cache.set("tokens:list", tokens, 86400).await?;
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **éƒ¨ç½²æŒ‡å—**: [05-deployment/DEPLOYMENT.md](../05-deployment/DEPLOYMENT.md)
- **ç›‘æ§å‘Šè­¦**: [07-monitoring/MONITORING.md](../07-monitoring/MONITORING.md)
- **é…ç½®ç®¡ç†**: [02-configuration/CONFIG_MANAGEMENT.md](../02-configuration/CONFIG_MANAGEMENT.md)
- **æ•°æ®åº“è®¾è®¡**: [02-configuration/DATABASE_SCHEMA.md](../02-configuration/DATABASE_SCHEMA.md)

---

**æœ€åæ›´æ–°**: 2025-12-06  
**ç»´æŠ¤è€…**: SRE & Operations Team  
**å®¡æŸ¥è€…**: Infrastructure Lead, SRE Manager
