-- ============================================================================
-- Migration: 0046_update_fiat_providers_v2.sql
-- Description: ä¼˜åŒ–æ”¯ä»˜æœåŠ¡å•†é…ç½® - æ·»åŠ Onramper/TransFi/Alchemy Payï¼Œæ›´æ–°ä¼˜å…ˆçº§
-- Date: 2025-12-05
-- Version: 2 (é¿å…ä¸0033å†²çª)
-- ============================================================================

-- Step 1: æ·»åŠ provider_typeå­—æ®µï¼ŒåŒºåˆ†èšåˆå™¨å’Œç›´è¿
ALTER TABLE fiat.providers ADD COLUMN IF NOT EXISTS provider_type TEXT NOT NULL DEFAULT 'direct';
COMMENT ON COLUMN fiat.providers.provider_type IS 'Provider type: aggregator (èšåˆå™¨) or direct (ç›´è¿)';

-- Step 2: æ›´æ–°ç°æœ‰5ä¸ªæœåŠ¡å•†çš„ä¼˜å…ˆçº§
-- é™ä½Simplex/Transak/Banxaä¼˜å…ˆçº§ï¼ˆå‡†å¤‡ç§»é™¤ï¼‰
UPDATE fiat.providers SET priority = 50, is_enabled = false WHERE name = 'simplex';
UPDATE fiat.providers SET priority = 50, is_enabled = false WHERE name = 'transak';
UPDATE fiat.providers SET priority = 50, is_enabled = false WHERE name = 'banxa';

-- ä¿ç•™MoonPayå’ŒRampä½œä¸ºå…œåº•
UPDATE fiat.providers SET priority = 60 WHERE name = 'moonpay';
UPDATE fiat.providers SET priority = 70 WHERE name = 'ramp';

-- Step 3: æ’å…¥æ–°æœåŠ¡å•† - Onramper (èšåˆå™¨)
INSERT INTO fiat.providers (
    name,
    display_name,
    provider_type,
    is_enabled,
    priority,
    fee_min_percent,
    fee_max_percent,
    api_url,
    webhook_url,
    timeout_seconds,
    supported_countries,
    supported_payment_methods,
    health_status
) VALUES (
    'onramper',
    'Onramper (Aggregator)',
    'aggregator',
    true,
    100,  -- æœ€é«˜ä¼˜å…ˆçº§
    0.5,
    4.0,
    'https://api.onramper.com',
    '/api/v1/fiat/webhook/onramper',
    30,
    ARRAY['GLOBAL'],  -- å…¨çƒæ”¯æŒ
    ARRAY['credit_card', 'debit_card', 'bank_transfer', 'alipay', 'wechat_pay', 'apple_pay', 'google_pay'],
    'unknown'
) ON CONFLICT (name) DO UPDATE SET
    display_name = EXCLUDED.display_name,
    provider_type = EXCLUDED.provider_type,
    priority = EXCLUDED.priority,
    fee_min_percent = EXCLUDED.fee_min_percent,
    fee_max_percent = EXCLUDED.fee_max_percent,
    supported_payment_methods = EXCLUDED.supported_payment_methods;

-- Step 4: æ’å…¥æ–°æœåŠ¡å•† - TransFi (ä¸­å›½ç‰¹åŒ–)
INSERT INTO fiat.providers (
    name,
    display_name,
    provider_type,
    is_enabled,
    priority,
    fee_min_percent,
    fee_max_percent,
    api_url,
    webhook_url,
    timeout_seconds,
    supported_countries,
    supported_payment_methods,
    health_status
) VALUES (
    'transfi',
    'TransFi (China/Emerging)',
    'direct',
    true,
    90,  -- ä¸­å›½ç”¨æˆ·é«˜ä¼˜å…ˆçº§
    1.5,
    3.5,
    'https://api.transfi.com',
    '/api/v1/fiat/webhook/transfi',
    30,
    ARRAY['CN', 'HK', 'TW', 'SG', 'NG', 'KE', 'ZA', 'BR', 'MX', 'AR'],  -- ä¸­å›½+æ–°å…´å¸‚åœº
    ARRAY['alipay', 'wechat_pay', 'credit_card', 'bank_transfer', 'mpesa', 'pix'],
    'unknown'
) ON CONFLICT (name) DO UPDATE SET
    display_name = EXCLUDED.display_name,
    priority = EXCLUDED.priority,
    fee_min_percent = EXCLUDED.fee_min_percent,
    fee_max_percent = EXCLUDED.fee_max_percent,
    supported_countries = EXCLUDED.supported_countries,
    supported_payment_methods = EXCLUDED.supported_payment_methods;

-- Step 5: æ’å…¥æ–°æœåŠ¡å•† - Alchemy Pay (Web3ä¼˜åŒ–)
INSERT INTO fiat.providers (
    name,
    display_name,
    provider_type,
    is_enabled,
    priority,
    fee_min_percent,
    fee_max_percent,
    api_url,
    webhook_url,
    timeout_seconds,
    supported_countries,
    supported_payment_methods,
    health_status
) VALUES (
    'alchemypay',
    'Alchemy Pay (Web3)',
    'direct',
    true,
    85,  -- Web3åœºæ™¯ä¼˜å…ˆ
    1.0,
    3.0,
    'https://api.alchemypay.org',
    '/api/v1/fiat/webhook/alchemypay',
    30,
    ARRAY['CN', 'HK', 'TW', 'SG', 'JP', 'KR', 'TH', 'VN', 'ID', 'MY', 'PH'],  -- äºšå¤ªä¼˜å…ˆ
    ARRAY['alipay', 'wechat_pay', 'credit_card', 'apple_pay', 'google_pay', 'bank_transfer'],
    'unknown'
) ON CONFLICT (name) DO UPDATE SET
    display_name = EXCLUDED.display_name,
    priority = EXCLUDED.priority,
    fee_min_percent = EXCLUDED.fee_min_percent,
    fee_max_percent = EXCLUDED.fee_max_percent,
    supported_countries = EXCLUDED.supported_countries,
    supported_payment_methods = EXCLUDED.supported_payment_methods;

-- Step 6: æ·»åŠ å”¯ä¸€çº¦æŸï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
DO $$ 
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'providers_name_unique' 
        AND conrelid = 'fiat.providers'::regclass
    ) THEN
        ALTER TABLE fiat.providers ADD CONSTRAINT providers_name_unique UNIQUE (name);
    END IF;
END $$;

-- Step 7: åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX IF NOT EXISTS idx_providers_priority_enabled ON fiat.providers(priority DESC, is_enabled) WHERE is_enabled = true;
CREATE INDEX IF NOT EXISTS idx_providers_type ON fiat.providers(provider_type);
CREATE INDEX IF NOT EXISTS idx_providers_health ON fiat.providers(health_status) WHERE is_enabled = true;

-- Step 8: æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE fiat.providers IS 'æ³•å¸æ”¯ä»˜æœåŠ¡å•†é…ç½®è¡¨ - æ”¯æŒèšåˆå™¨å’Œç›´è¿ä¸¤ç§ç±»å‹';
COMMENT ON COLUMN fiat.providers.provider_type IS 'aggregator: èšåˆå™¨(Onramper), direct: ç›´è¿æœåŠ¡å•†';
COMMENT ON COLUMN fiat.providers.priority IS 'ä¼˜å…ˆçº§: 100=Onramperèšåˆå™¨, 90=TransFiä¸­å›½, 85=Alchemyäºšå¤ª, 70=Rampæ¬§ç¾, 60=MoonPayå…œåº•';

-- Step 9: æŸ¥è¯¢éªŒè¯
DO $$ 
DECLARE
    provider_count INT;
    enabled_count INT;
BEGIN
    SELECT COUNT(*) INTO provider_count FROM fiat.providers;
    SELECT COUNT(*) INTO enabled_count FROM fiat.providers WHERE is_enabled = true;
    
    RAISE NOTICE 'âœ… Migration completed successfully!';
    RAISE NOTICE 'ğŸ“Š Total providers: %, Enabled: %', provider_count, enabled_count;
    RAISE NOTICE 'ğŸ¯ Priority order:';
    RAISE NOTICE '  100 - Onramper (Aggregator)';
    RAISE NOTICE '   90 - TransFi (China)';
    RAISE NOTICE '   85 - Alchemy Pay (Web3)';
    RAISE NOTICE '   70 - Ramp (EU/US)';
    RAISE NOTICE '   60 - MoonPay (Global Fallback)';
    RAISE NOTICE '   50 - Simplex/Transak/Banxa (Disabled)';
END $$;
